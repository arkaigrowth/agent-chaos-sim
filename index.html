<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chaos Lab â€” Agent Resilience Tester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="hero">
    <h1 data-copy="hero.title">Agent Chaos Monkey</h1>
    <p class="sub" data-copy="hero.sub">
      Test your AI agent's resilience by simulating real-world failures. 
      See how well your agent handles API errors, network issues, and unexpected responses.
    </p>
    <div class="hero-actions">
      <a href="docs/" class="link" style="text-decoration: none;">ğŸš€ Launch Testing Suite â†’</a>
      <a href="#setup" class="link" style="text-decoration: none; margin-left: 1rem;">ğŸ“š Run Locally</a>
    </div>
  </header>

  <!-- Testing Modes Showcase -->
  <section class="modes-showcase" style="padding: 2rem; text-align: center;">
    <h2 style="color: #00ff41; margin-bottom: 2rem;">Choose Your Testing Mode</h2>
    <div style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
      <div class="mode-card" style="background: #1a1a1a; border: 1px solid #00ff41; padding: 1.5rem; border-radius: 8px; max-width: 300px;">
        <h3 style="color: #00ff41;">ğŸ® Basic Testing</h3>
        <p>Interactive chaos scenarios with real-time ASCII theatre visualization</p>
        <a href="docs/" class="link">Try Basic Mode â†’</a>
      </div>
      <div class="mode-card" style="background: #1a1a1a; border: 1px solid #00ff41; padding: 1.5rem; border-radius: 8px; max-width: 300px;">
        <h3 style="color: #00ff41;">ğŸ”¬ Task Mode</h3>
        <p>Advanced LLM testing with actionable insights and code recommendations</p>
        <a href="docs/" class="link">Try Task Mode â†’</a>
      </div>
    </div>
  </section>

  <!-- 60s storytelling strip -->
  <section class="story">
    <div class="step">
      <div data-copy="story.step1.title">Pick a scenario</div>
      <span data-copy="story.step1.sub">Web Â· Mini-RAG Â· JSONâ†’Table</span>
    </div>
    <div class="step">
      <div data-copy="story.step2.title">Run baseline</div>
      <span data-copy="story.step2.sub">Clean control metrics</span>
    </div>
    <div class="step">
      <div data-copy="story.step3.title">Toggle chaos</div>
      <span data-copy="story.step3.sub">500s Â· 429s Â· latency Â· bad JSON</span>
    </div>
    <div class="step">
      <div data-copy="story.step4.title">Compare & Remix</div>
      <span data-copy="story.step4.sub">Trace + Score + one-click fork</span>
    </div>
  </section>

  <!-- About explainer -->
  <section class="card">
    <h2 data-copy="about.title">Why Test Agent Resilience?</h2>
    <details open>
      <summary data-copy="about.short.title">What is Chaos Lab?</summary>
      <p data-copy="about.short.body">
        Chaos Lab simulates real-world failures to test how well your AI agents handle unexpected situations. 
        It introduces controlled failures like API timeouts, network errors, and malformed data to reveal weaknesses 
        in your agent's error handling and recovery logic.
      </p>
    </details>
    <details>
      <summary data-copy="about.when.title">When should you use this?</summary>
      <ul id="about-when-list" data-copy="about.when.items">
        <li>Before deploying agents to production environments</li>
        <li>When debugging intermittent failures in your workflows</li>
        <li>To validate your retry logic and fallback strategies</li>
        <li>To benchmark agent performance under adverse conditions</li>
      </ul>
    </details>
    <details>
      <summary data-copy="about.score.title">Understanding the Resilience Score</summary>
      <p data-copy="about.score.body">
        Your score combines success rate after failures, recovery time, and consistency of responses. 
        A score of 70+ indicates good resilience, while 90+ suggests enterprise-ready robustness.
      </p>
    </details>
  </section>

  <!-- Quick examples (storytelling/marketing) -->
  <section class="card" id="examplesCard">
    <h2>What can I test? <a class="link" href="/docs/faq.md" target="_blank" rel="noopener">FAQ</a></h2>
    <div class="examples" id="examplesGrid"></div>
    <details id="faqInline" class="hidden">
      <summary>Open FAQ inline</summary>
      <div id="faqContent"></div>
    </details>
  </section>

  <main class="container">
    <section class="card">
      <h2>Choose Your Test Scenario</h2>
      <p class="hint">Select a scenario that matches your agent's typical workflow. These are pre-configured test cases.</p>
      
      <!-- Preset Buttons -->
      <div class="presets">
        <button class="preset-btn" data-preset="quick">ğŸš€ Quick Test</button>
        <button class="preset-btn" data-preset="network">ğŸŒ Network Chaos</button>
        <button class="preset-btn" data-preset="heavy">âš¡ Heavy Load</button>
        <button class="preset-btn" data-preset="full">ğŸ”¥ Full Chaos</button>
      </div>
      
      <div class="row">
        <label><input type="radio" name="scenario" value="fetch" checked> ğŸŒ Web Scraping â†’ Content Extraction</label>
        <label><input type="radio" name="scenario" value="rag"> ğŸ“š Document Q&A â†’ Knowledge Retrieval</label>
        <label><input type="radio" name="scenario" value="json"> ğŸ”§ API Integration â†’ Data Processing</label>
      </div>
      <details class="hint"><summary>View scenario details</summary>
        <ul>
          <li><strong>Web Scraping:</strong> Tests HTML fetching and content extraction from <code>httpbin.org</code></li>
          <li><strong>Document Q&A:</strong> Tests retrieval-augmented generation with local documentation</li>
          <li><strong>API Integration:</strong> Tests JSON fetching and data processing from <code>jsonplaceholder.typicode.com</code></li>
        </ul>
      </details>
    </section>

    <section class="card">
      <h2>Configure Failure Scenarios</h2>
      <p class="hint">Adjust these settings to simulate real-world issues your agent might encounter in production.</p>
      <div class="grid">
        <label>Network Latency Spike (ms)
          <input id="latencyMs" type="number" min="0" value="2000">
        </label>
        <label>Latency Occurrence Rate (%)
          <input id="latencyRate" type="number" step="5" min="0" max="100" value="20">
        </label>
        <label>Server Error Rate (HTTP 500) (%)
          <input id="http500Rate" type="number" step="5" min="0" max="100" value="10">
        </label>
        <label>Rate Limiting (HTTP 429) (%)
          <input id="rate429" type="number" step="5" min="0" max="100" value="10">
        </label>
        <label>Malformed Response Rate (%)
          <input id="malformedRate" type="number" step="5" min="0" max="100" value="15">
        </label>
        <label>Tool Unavailable Steps
          <input id="toolUnavailableSteps" type="number" min="0" value="0">
        </label>
        <label>Security Test Seed
          <input id="injSeed" type="text" value="benign-01">
        </label>
        <label>Context Window Limit (bytes)
          <input id="ctxBytes" type="number" min="0" value="8192">
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Recovery & Resilience Settings</h2>
      <p class="hint">Configure how your agent should handle and recover from failures.</p>
      <div class="row">
        <label><input id="tripwireOn" type="checkbox" checked> âœ… Enable Smart Recovery (recommended)</label>
      </div>
      <div class="grid">
        <label>Loop Prevention Threshold
          <input id="loopN" type="number" min="2" value="3">
        </label>
        <label>Retry Delay Base (ms)
          <input id="backoffBase" type="number" min="0" value="250">
        </label>
        <label>Exponential Backoff Factor
          <input id="backoffFactor" type="number" step="0.1" min="1" value="2.0">
        </label>
        <label>Random Jitter (0-1)
          <input id="jitter" type="number" step="0.05" min="0" max="1" value="0.2">
        </label>
        <label>Maximum Retry Attempts
          <input id="maxRetries" type="number" min="0" value="3">
        </label>
        <label>Fallback Strategy
          <input id="fallback" type="text" value="use_cached_summary">
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Run Your Tests</h2>
      <p class="hint">Start with a baseline run to establish normal performance, then run with chaos to test resilience.</p>
      <div class="row">
        <label>Test Seed (for reproducibility)
          <input id="seed" type="text" value="1337">
        </label>
        <label><input id="surprise" type="checkbox"> ğŸ² Randomize settings</label>
        <button id="btnReplay" class="secondary">â†» Replay Last Test</button>
      </div>
      <div class="row">
        <button id="btnBaseline" class="primary">â–¶ï¸ Run Baseline Test</button>
        <button id="btnChaos" class="danger">âš¡ Run Chaos Test</button>
        <button id="btnPermalink" class="secondary">ğŸ”— Share Configuration</button>
      </div>
    </section>

    <!-- â›³ INSERT Chaos Theatre HERE: after Run, before Compare/Results -->
    <section class="card" id="chaosTheatreCard">
      <h2>Chaos ASCII Theatre (beta)</h2>
      <div class="row">
        <label><input id="asciiOnly" type="checkbox"> ASCII-only</label>
        <label><input id="soundOn" type="checkbox"> Sound ON</label>
        <label><input id="mouseSpice" type="checkbox"> Mouse spice</label>
      </div>
      <pre id="stage" class="ascii" aria-live="polite" aria-label="Chaos visualization"></pre>
      <div id="timelineRail" class="timeline">Timeline: </div>
      <div class="hint">
        Legend: â— packet Â· â˜500 Â· â›”429 Â· â³ latency Â· â–¢â†’â—‡ malformed Â· âŠ˜ tool Â· ğŸ’£ ctx Â· âœ“ recovered
      </div>
    </section>

    <section class="card" id="evalsCard">
      <h2>Resilience Evals (beta)</h2>

      <div class="row">
        <label>
          Suite:
          <select id="evalSuiteSelect">
            <option value="reliability_core">Reliability Core</option>
            <option value="rag_injection">RAG Injection (benign)</option>
            <option value="rate_limit_backoff">Rate-limit Backoff Discipline</option>
            <option value="custom">Upload custom YAML/JSONâ€¦</option>
          </select>
        </label>
        <label><input type="checkbox" id="evalIncludeBaseline"> Include baseline</label>
      </div>

      <div class="row" id="evalUploadRow" style="display:none">
        <input type="file" id="evalFile" accept=".yml,.yaml,.json" />
        <small class="hint">Schema: suite â†’ cases[] with scenario, seeds[], faults{{â€¦}}, assertions[]</small>
      </div>

      <div class="row">
        <button id="btnRunEval" class="primary">Run Suite</button>
        <button id="btnExportEvalJSON" disabled>Export JSON</button>
        <button id="btnExportEvalMD" disabled>Export MD</button>
        <button id="btnEvalPermalink" disabled>Copy permalink</button>
      </div>

      <pre id="evalOutput" class="ascii" style="height:260px; white-space:pre-wrap;"></pre>
    </section>

    <!-- Compare card -->
    <section class="card hidden" id="compareCard" aria-live="polite">
      <h2>Baseline vs Chaos</h2>
      
      <!-- Visual Comparison -->
      <div class="visualizations">
        <div class="viz-container">
          <div class="viz-header">Resilience Score</div>
          <canvas id="scoreGauge" width="200" height="120"></canvas>
        </div>
        <div class="viz-container">
          <div class="viz-header">Performance Comparison</div>
          <canvas id="comparisonChart" width="300" height="180"></canvas>
        </div>
      </div>
      
      <div class="compare">
        <div class="col">
          <div class="label">Baseline</div>
          <div class="badge" id="baselineBadge">Score: â€”</div>
          <div id="baselineMetrics" class="mini"></div>
        </div>
        <div class="col">
          <div class="label">Chaos</div>
          <div class="badge" id="chaosBadge">Score: â€”</div>
          <div id="chaosMetrics" class="mini"></div>
        </div>
        <div class="delta">
          Î” Score: <span id="deltaScore">â€”</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Test Results & Analysis</h2>
      <p class="hint">Your agent's performance metrics and detailed execution trace will appear here after running tests.</p>

      <div id="gateBanner" class="gate hidden" role="alert"></div>
      <div class="row">
        <label>Minimum Acceptable Score
          <input id="minScore" type="number" min="0" max="100" value="70">
        </label>
        <button id="btnReport" class="secondary">ğŸ“Š Export Report</button>
      </div>

      <div id="scoreBadge" class="badge">ğŸ¯ Resilience Score: â€”</div>
      <div id="metrics"></div>

      <div class="trace-controls">
        <button id="btnDownload" class="secondary">ğŸ’¾ Download Trace Data</button>
        <button id="btnViewConfig" class="secondary">âš™ï¸ View Configuration</button>
        <button id="btnCopyConfig" class="secondary">ğŸ“‹ Copy YAML Config</button>
      </div>
      <pre id="configView" class="code hidden"></pre>
      
      <div class="trace-view-controls">
        <span style="color: var(--fg); font-family: var(--font-mono); font-size: 14px; font-weight: 600;">VIEW:</span>
        <button id="btnViewTable" class="view-toggle-btn active" data-tip="Show trace data in table format">ğŸ“Š TABLE</button>
        <button id="btnViewJSON" class="view-toggle-btn" data-tip="Show raw trace data in collapsible JSON format">ğŸ”§ JSON</button>
        <button id="btnViewGraph" class="view-toggle-btn" data-tip="Show ASCII graph visualization of execution flow">ğŸ“ˆ GRAPH</button>
      </div>
      
      <table id="traceTable" class="trace"><thead>
        <tr><th>Step</th><th>Tool</th><th>Fault Injected?</th><th>Action</th><th>Duration</th><th>Result</th></tr>
      </thead><tbody></tbody></table>
      
      <div id="jsonViewer" class="json-viewer hidden">
        <div class="json-viewer-header" onclick="toggleJSONViewer()">
          <span>âš¡ RAW TRACE DATA</span>
          <span class="json-viewer-toggle">â–¼</span>
        </div>
        <div class="json-viewer-content">
          <pre id="jsonCode" class="json-code"></pre>
        </div>
      </div>
      
      <div id="asciiGraph" class="ascii-graph hidden"></div>
    </section>

    <section class="card">
      <h2>Ready to Deploy?</h2>
      <p class="hint">
        Once you achieve a good resilience score, your agent is ready for production. 
        Consider setting up monitoring to catch real-world issues early.
      </p>
      <div class="row">
        <button id="btnRemixBottom" class="primary">ğŸš€ Deploy Your Agent</button>
        <button class="secondary">ğŸ“š Learn More</button>
      </div>
    </section>
  </main>

  <!-- Run status toast (progress + messages) -->
  <div id="runStatus" class="toast hidden" role="status" aria-live="polite" aria-atomic="true">
    <div class="toast-inner">
      <div class="toast-title" id="runTitle">Runningâ€¦</div>
      <div class="bar"><span id="barFill"></span><span id="barText">0%</span></div>
      <div class="toast-msg" id="runMsg">Starting scenarioâ€¦</div>
    </div>
  </div>

  <!-- Enhanced Onboarding modal -->
  <div id="modalOnboarding" class="modal hidden">
    <div class="modal-inner">
      <div class="modal-close" id="modalClose">Ã—</div>
      <h3>Welcome to Chaos Lab! ğŸš€</h3>
      <div class="onboarding-step" id="step1">
        <h4>Step 1: Choose a Quick Start</h4>
        <p>Try our preset configurations to see how chaos testing works:</p>
        <div class="preset-demo">
          <button class="preset-btn small" disabled>ğŸš€ Quick Test</button>
          <span>â† Perfect for first-time users!</span>
        </div>
        <button class="primary" onclick="window.nextOnboardingStep()">Next â†’</button>
      </div>
      <div class="onboarding-step hidden" id="step2">
        <h4>Step 2: Run Baseline First</h4>
        <p>Always start with a baseline test to see normal performance:</p>
        <div class="demo-buttons">
          <button class="primary demo-btn" disabled>â–¶ï¸ Run Baseline Test</button>
        </div>
        <button class="primary" onclick="window.nextOnboardingStep()">Next â†’</button>
      </div>
      <div class="onboarding-step hidden" id="step3">
        <h4>Step 3: Add Some Chaos</h4>
        <p>Run the chaos test to see how your agent handles failures:</p>
        <div class="demo-buttons">
          <button class="danger demo-btn" disabled>âš¡ Run Chaos Test</button>
        </div>
        <button class="primary" onclick="window.nextOnboardingStep()">Next â†’</button>
      </div>
      <div class="onboarding-step hidden" id="step4">
        <h4>Step 4: Analyze Results</h4>
        <p>Check your resilience score and trace data:</p>
        <ul>
          <li>Score 70+ = Good resilience</li>
          <li>Score 90+ = Enterprise ready</li>
          <li>Review trace for failure patterns</li>
        </ul>
        <button class="primary" onclick="window.finishOnboarding()">Start Testing!</button>
      </div>
      <div class="onboarding-nav">
        <span id="stepIndicator">Step 1 of 4</span>
        <label><input id="dontShow" type="checkbox"> Don't show again</label>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="/theatre.css" />
  <script src="/theatre.js"></script>
  <script src="/evals.js"></script>
  <!-- Script removed - examples are loaded by app.js -->
  <script src="/app.js"></script>
  <script src="/ui-integration-test.js"></script>
  <script src="/theme-switcher.js"></script>
</body>
</html>
