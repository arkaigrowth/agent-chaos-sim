<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chaos Lab - Analytics Dashboard</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: #0a0a0a;
  color: #00ff41;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  line-height: 1.6;
  padding: 20px;
}

.analytics-container {
  max-width: 1400px;
  margin: 0 auto;
}

/* Header */
.analytics-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
  border: 1px solid #333;
  border-radius: 8px;
  margin-bottom: 20px;
}

.analytics-title {
  font-size: 24px;
  font-weight: bold;
  color: #00ff41;
  text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.dashboard-panel {
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 20px;
  font-family: 'Courier New', monospace;
}

.dashboard-panel.full-width {
  grid-column: 1 / -1;
}

.panel-title {
  color: #00ff41;
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 15px;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 1px solid #333;
  padding-bottom: 8px;
}

/* Graph Display */
.graph-display {
  font-size: 12px;
  line-height: 1.2;
  white-space: pre;
  color: #00ff41;
  background: #000;
  padding: 15px;
  border-radius: 4px;
  overflow-x: auto;
}

/* Score Display */
.score-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.score-card {
  background: #0f0f0f;
  border: 1px solid #2a2a2a;
  border-radius: 6px;
  padding: 15px;
  text-align: center;
  transition: all 0.3s;
}

.score-card:hover {
  border-color: #00ff41;
  box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
}

.score-value {
  font-size: 32px;
  font-weight: bold;
  margin-bottom: 5px;
}

.score-label {
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.score-high { color: #00ff41; }
.score-medium { color: #ffaa00; }
.score-low { color: #ff4444; }

/* Insights Panel */
.insights-panel {
  background: #0f0f0f;
  border: 2px solid #00ff41;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.insights-section {
  margin-bottom: 20px;
}

.insights-section:last-child {
  margin-bottom: 0;
}

.insights-title {
  color: #ffaa00;
  font-size: 13px;
  font-weight: bold;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.insight-item {
  padding: 8px 0;
  border-bottom: 1px solid #1a1a1a;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.insight-item:last-child {
  border-bottom: none;
}

.insight-icon {
  color: #00ff41;
}

.insight-points {
  margin-left: auto;
  color: #00ff41;
  font-weight: bold;
  font-size: 11px;
}

/* Control Buttons */
.analytics-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.analytics-btn {
  background: #1a1a1a;
  border: 1px solid #00ff41;
  color: #00ff41;
  padding: 10px 20px;
  border-radius: 4px;
  font-family: inherit;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.analytics-btn:hover {
  background: #00ff41;
  color: #000;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 255, 65, 0.3);
}

.analytics-btn.active {
  background: #00ff41;
  color: #000;
  font-weight: bold;
}

/* Live Monitor */
.live-monitor {
  background: #000;
  border: 2px solid #333;
  border-radius: 8px;
  padding: 15px;
  font-size: 12px;
  line-height: 1.4;
  white-space: pre;
  font-family: 'Courier New', monospace;
  color: #00ff41;
  position: relative;
  overflow: hidden;
}

.live-monitor.active {
  border-color: #00ff41;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 65, 0.2); }
  50% { box-shadow: 0 0 30px rgba(0, 255, 65, 0.4); }
}

/* Status Indicators */
.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 8px;
  animation: blink 1s infinite;
}

.status-healthy { background: #00ff41; }
.status-degraded { background: #ffaa00; }
.status-critical { background: #ff4444; }

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Export Modal */
.export-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #1a1a1a;
  border: 2px solid #00ff41;
  border-radius: 8px;
  padding: 30px;
  z-index: 1000;
  max-width: 600px;
  width: 90%;
}

.export-modal.active {
  display: block;
}

.modal-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 999;
}

.modal-backdrop.active {
  display: block;
}

.export-content {
  background: #000;
  border: 1px solid #333;
  border-radius: 4px;
  padding: 15px;
  font-size: 11px;
  max-height: 400px;
  overflow-y: auto;
  white-space: pre-wrap;
  font-family: 'Courier New', monospace;
  color: #00ff41;
  margin-top: 20px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .score-container {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>
<body>

<div class="analytics-container">
  <!-- Header -->
  <div class="analytics-header">
    <div class="analytics-title">üß™ CHAOS ANALYTICS DASHBOARD</div>
    <div id="liveStatus">
      <span class="status-indicator status-healthy"></span>
      <span>System Healthy</span>
    </div>
  </div>

  <!-- Score Cards -->
  <div class="score-container">
    <div class="score-card">
      <div class="score-value score-high" id="overallScore">--</div>
      <div class="score-label">Overall Score</div>
    </div>
    <div class="score-card">
      <div class="score-value score-medium" id="recoveryScore">--</div>
      <div class="score-label">Recovery Time</div>
    </div>
    <div class="score-card">
      <div class="score-value score-medium" id="successScore">--</div>
      <div class="score-label">Success Rate</div>
    </div>
    <div class="score-card">
      <div class="score-value score-low" id="adaptScore">--</div>
      <div class="score-label">Adaptation</div>
    </div>
  </div>

  <!-- Control Buttons -->
  <div class="analytics-controls">
    <button class="analytics-btn" onclick="refreshAnalytics()">Refresh</button>
    <button class="analytics-btn" onclick="toggleLiveMode()">Live Mode</button>
    <button class="analytics-btn" onclick="exportReport('report')">Export Report</button>
    <button class="analytics-btn" onclick="exportReport('json')">Export JSON</button>
    <button class="analytics-btn" onclick="exportReport('csv')">Export CSV</button>
    <button class="analytics-btn" onclick="clearData()">Clear Data</button>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Timeline Graph -->
    <div class="dashboard-panel">
      <div class="panel-title">Effect Timeline</div>
      <div class="graph-display" id="timelineGraph">
        Waiting for data...
      </div>
    </div>

    <!-- Success Rate Graph -->
    <div class="dashboard-panel">
      <div class="panel-title">Success Rate by Error Type</div>
      <div class="graph-display" id="successGraph">
        Waiting for data...
      </div>
    </div>

    <!-- Performance Graph -->
    <div class="dashboard-panel">
      <div class="panel-title">Recovery Performance</div>
      <div class="graph-display" id="performanceGraph">
        Waiting for data...
      </div>
    </div>

    <!-- Live Monitor -->
    <div class="dashboard-panel">
      <div class="panel-title">Live Monitor</div>
      <div class="live-monitor" id="liveMonitor">
        Waiting for data...
      </div>
    </div>

    <!-- Resilience Meter -->
    <div class="dashboard-panel full-width">
      <div class="panel-title">Resilience Analysis</div>
      <div class="graph-display" id="resilienceMeter">
        Waiting for data...
      </div>
    </div>
  </div>

  <!-- Insights Panel -->
  <div class="insights-panel">
    <div class="insights-section">
      <div class="insights-title">‚ö†Ô∏è Critical Issues</div>
      <div id="weaknessList"></div>
    </div>
    
    <div class="insights-section">
      <div class="insights-title">üîß Recommended Fixes</div>
      <div id="recommendationList"></div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-backdrop" onclick="closeExportModal()"></div>
<div class="export-modal" id="exportModal">
  <div class="panel-title">Export Analytics</div>
  <div class="export-content" id="exportContent"></div>
  <div style="margin-top: 20px; text-align: right;">
    <button class="analytics-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
    <button class="analytics-btn" onclick="downloadExport()">Download</button>
    <button class="analytics-btn" onclick="closeExportModal()">Close</button>
  </div>
</div>

<script src="chaos_analytics.js"></script>
<script>
// Analytics Integration Script
let analytics = null;
let liveMode = false;
let liveInterval = null;
let currentExportData = null;
let currentExportFormat = null;

// Initialize analytics when parent data collector is available
function initializeAnalytics(dataCollector) {
  analytics = new ChaosAnalytics(dataCollector);
  refreshAnalytics();
}

// Refresh all analytics displays
function refreshAnalytics() {
  if (!analytics) {
    console.warn('Analytics not initialized');
    return;
  }
  
  // Get analysis data
  const analysis = analytics.analyzeResilience();
  
  // Update score cards
  updateScoreCard('overallScore', analysis.overall_score);
  updateScoreCard('recoveryScore', analysis.components.recovery_time);
  updateScoreCard('successScore', analysis.components.success_rate);
  updateScoreCard('adaptScore', analysis.components.adaptation);
  
  // Update graphs
  document.getElementById('timelineGraph').textContent = analytics.generateTimelineGraph();
  document.getElementById('successGraph').textContent = analytics.generateSuccessRateGraph();
  document.getElementById('performanceGraph').textContent = analytics.generatePerformanceGraph();
  document.getElementById('resilienceMeter').textContent = analytics.generateAnalysisReport();
  
  // Update live monitor
  document.getElementById('liveMonitor').textContent = analytics.generateLiveMonitor();
  
  // Update insights
  updateInsights(analysis);
  
  // Update status
  updateSystemStatus(analysis.overall_score);
}

// Update score card with color coding
function updateScoreCard(elementId, score) {
  const element = document.getElementById(elementId);
  element.textContent = score;
  
  // Update color based on score
  element.className = 'score-value';
  if (score >= 80) {
    element.classList.add('score-high');
  } else if (score >= 60) {
    element.classList.add('score-medium');
  } else {
    element.classList.add('score-low');
  }
}

// Update insights panels
function updateInsights(analysis) {
  // Update weaknesses
  const weaknessList = document.getElementById('weaknessList');
  weaknessList.innerHTML = '';
  
  if (analysis.weaknesses.length === 0) {
    weaknessList.innerHTML = '<div class="insight-item">No critical issues detected</div>';
  } else {
    analysis.weaknesses.forEach(weakness => {
      const item = document.createElement('div');
      item.className = 'insight-item';
      item.innerHTML = `
        <span class="insight-icon">‚ñ∂</span>
        <span>${weakness}</span>
      `;
      weaknessList.appendChild(item);
    });
  }
  
  // Update recommendations
  const recommendationList = document.getElementById('recommendationList');
  recommendationList.innerHTML = '';
  
  if (analysis.recommendations.length === 0) {
    recommendationList.innerHTML = '<div class="insight-item">System performing optimally</div>';
  } else {
    analysis.recommendations.slice(0, 5).forEach(rec => {
      const item = document.createElement('div');
      item.className = 'insight-item';
      const match = rec.match(/(.+)\s\((\+\d+\spoints)\)/);
      if (match) {
        item.innerHTML = `
          <span class="insight-icon">‚ñ°</span>
          <span>${match[1]}</span>
          <span class="insight-points">${match[2]}</span>
        `;
      } else {
        item.innerHTML = `
          <span class="insight-icon">‚ñ°</span>
          <span>${rec}</span>
        `;
      }
      recommendationList.appendChild(item);
    });
  }
}

// Update system status indicator
function updateSystemStatus(score) {
  const statusEl = document.getElementById('liveStatus');
  const indicator = statusEl.querySelector('.status-indicator');
  const text = statusEl.querySelector('span:last-child');
  
  indicator.className = 'status-indicator';
  
  if (score >= 80) {
    indicator.classList.add('status-healthy');
    text.textContent = 'System Healthy';
  } else if (score >= 60) {
    indicator.classList.add('status-degraded');
    text.textContent = 'System Degraded';
  } else {
    indicator.classList.add('status-critical');
    text.textContent = 'System Critical';
  }
}

// Toggle live mode
function toggleLiveMode() {
  liveMode = !liveMode;
  const btn = event.target;
  
  if (liveMode) {
    btn.classList.add('active');
    document.getElementById('liveMonitor').parentElement.parentElement.classList.add('active');
    
    // Start live updates
    liveInterval = setInterval(() => {
      document.getElementById('liveMonitor').textContent = analytics.generateLiveMonitor();
      
      // Update scores if significant changes
      if (Math.random() < 0.3) {
        refreshAnalytics();
      }
    }, 1000);
  } else {
    btn.classList.remove('active');
    document.getElementById('liveMonitor').parentElement.parentElement.classList.remove('active');
    
    // Stop live updates
    if (liveInterval) {
      clearInterval(liveInterval);
      liveInterval = null;
    }
  }
}

// Export report
function exportReport(format) {
  if (!analytics) {
    alert('No analytics data available');
    return;
  }
  
  currentExportFormat = format;
  currentExportData = analytics.exportAnalytics(format);
  
  // Show modal with export data
  document.getElementById('exportContent').textContent = currentExportData;
  document.getElementById('exportModal').classList.add('active');
  document.querySelector('.modal-backdrop').classList.add('active');
}

// Close export modal
function closeExportModal() {
  document.getElementById('exportModal').classList.remove('active');
  document.querySelector('.modal-backdrop').classList.remove('active');
}

// Copy to clipboard
function copyToClipboard() {
  if (!currentExportData) return;
  
  navigator.clipboard.writeText(currentExportData).then(() => {
    alert('Copied to clipboard!');
  }).catch(err => {
    console.error('Failed to copy:', err);
  });
}

// Download export
function downloadExport() {
  if (!currentExportData || !currentExportFormat) return;
  
  const blob = new Blob([currentExportData], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const extension = currentExportFormat === 'json' ? 'json' : 
                     currentExportFormat === 'csv' ? 'csv' : 'txt';
  
  a.href = url;
  a.download = `chaos-analytics-${timestamp}.${extension}`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Clear data
function clearData() {
  if (confirm('Clear all analytics data? This cannot be undone.')) {
    if (analytics && analytics.dataCollector) {
      analytics.dataCollector.traces = [];
      analytics.dataCollector.performance = {
        startTime: 0,
        interactions: 0,
        effectsInjected: 0,
        recoveryAttempts: 0
      };
      refreshAnalytics();
    }
  }
}

// Auto-refresh in live mode
setInterval(() => {
  if (liveMode && analytics) {
    const monitor = document.getElementById('liveMonitor');
    if (monitor) {
      monitor.textContent = analytics.generateLiveMonitor();
    }
  }
}, 2000);

// Listen for messages from parent window
window.addEventListener('message', (event) => {
  if (event.data.type === 'init-analytics' && event.data.dataCollector) {
    initializeAnalytics(event.data.dataCollector);
  } else if (event.data.type === 'update-analytics') {
    refreshAnalytics();
  }
});

// Standalone mode detection
if (window.opener || window.parent !== window) {
  // Running in iframe or popup - wait for parent to send data
  console.log('Analytics dashboard ready - waiting for data from parent');
} else {
  // Standalone mode - create mock data for demonstration
  console.log('Running in standalone mode with demo data');
  
  // Create mock DataCollector
  const mockDataCollector = {
    traces: [
      { step: 1, action: 'effect_injection', effect_type: '500_error', relative_time: 100 },
      { step: 2, action: 'recovery_attempt', relative_time: 150 },
      { step: 3, action: 'recovery_success', relative_time: 300 },
      { step: 4, action: 'effect_injection', effect_type: 'rate_limit', relative_time: 500 },
      { step: 5, action: 'recovery_attempt', relative_time: 600 },
      { step: 6, action: 'recovery_attempt', relative_time: 800 },
      { step: 7, action: 'recovery_success', relative_time: 1000 },
      { step: 8, action: 'effect_injection', effect_type: 'malformed_json', relative_time: 1200 },
      { step: 9, action: 'recovery_success', relative_time: 1250 },
      { step: 10, action: 'effect_injection', effect_type: 'network_timeout', relative_time: 1500 },
      { step: 11, action: 'recovery_attempt', relative_time: 1600 },
      { step: 12, action: 'recovery_success', relative_time: 1800 }
    ],
    performance: {
      startTime: 0,
      interactions: 12,
      effectsInjected: 4,
      recoveryAttempts: 4
    }
  };
  
  // Initialize with mock data
  setTimeout(() => {
    initializeAnalytics(mockDataCollector);
  }, 500);
}
</script>

</body>
</html>